<?php
// ===============================
//  SERVER‚ÄëSIDE IP‚ÄëBASED GEOFENCE
// ===============================
// Target location (must be approx ‚Äî IP is NOT GPS accurate)
$target_lat = 25.144911;
$target_lng = 75.862353;
$allowed_radius = 50; // meters

// Get user IP
$user_ip = $_SERVER['REMOTE_ADDR'];

// Fetch IP geolocation (using ip-api.com)
$geo = @json_decode(file_get_contents("http://ip-api.com/json/{$user_ip}"));

$inside = false;
$distance = null;

if ($geo && $geo->status === 'success') {
    $lat = $geo->lat;
    $lng = $geo->lon;

    // Haversine distance
    $R = 6371000;
    $dLat = deg2rad($lat - $target_lat);
    $dLon = deg2rad($lng - $target_lng);

    $a = sin($dLat/2)**2 + cos(deg2rad($target_lat)) * cos(deg2rad($lat)) * sin($dLon/2)**2;
    $distance = $R * 2 * atan2(sqrt($a), sqrt(1-$a));

    if ($distance <= $allowed_radius) {
        $inside = true;
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geofenced Form (IP Based)</title>
<style>
    body {
        background: #1a0000;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    h1 {
        font-size: 9vw;
        font-family: 'Lexend', sans-serif;
        color: #ff4d4d;
        text-shadow: 0 0 12px red;
    }
    .card {
        background: #330000;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 0 15px red;
        max-width: 480px;
        margin: auto;
    }
    button {
        background: #ff0000;
        color: #fff;
        padding: 15px 20px;
        border: none;
        border-radius: 10px;
        font-size: 20px;
        cursor: pointer;
        margin-top: 20px;
    }
</style>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<h1>üéÑ DealShare</h1>
<h2>Merry Christmas ‚Äî Location Verification</h2>

<div class="card">

<?php if ($geo && $geo->status === 'success'): ?>

    <p>Your detected location (via IP):<br><b><?= $geo->city ?>, <?= $geo->regionName ?>, <?= $geo->country ?></b></p>
    <p>Accuracy: <b>LOW (IP-based, not GPS)</b></p>
    <p>Distance from target: <b><?= round($distance) ?> meters</b></p>

    <?php if ($inside): ?>
        <h3 style="color:lime;">‚úî Access Granted</h3>
        <button onclick="window.location='https://docs.google.com/forms/d/e/1FAIpQLSeLi6rBSMcIp0b08-YIJM3RdP7TPjgnjR15RLnzTji1Vg9a_A/viewform?usp=header'">Open Form</button>
    <?php else: ?>
        <h3 style="color:red;">‚ùå Access Denied</h3>
        <p>You are outside the allowed 50m radius.</p>
    <?php endif; ?>

<?php else: ?>
    <h3 style="color:yellow;">‚ö† Location Unavailable</h3>
    <p>Your IP location could not be determined.</p>
<?php endif; ?>

</div>

</body>
</html>
