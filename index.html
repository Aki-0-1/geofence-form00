<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geofenced Google Form</title>

<style>
    body {
        background: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    #message {
        font-size: 22px;
        margin-top: 10px;
    }
    #accuracy {
        font-size: 16px;
        color: #fff88a;
        margin-top: 5px;
    }
    #distance {
        font-size: 18px;
        margin-top: 10px;
        color: #00d9ff;
    }
    #circle {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: #222;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 4px solid #444;
        font-size: 32px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    iframe {
        width: 100%;
        height: 600px;
        border: 1px solid #444;
        border-radius: 10px;
        margin-top: 15px;
    }
    button {
        background: #444;
        color: #fff;
        border: none;
        padding: 12px 20px;
        font-size: 18px;
        border-radius: 6px;
        margin-top: 10px;
        display: none;
        cursor: pointer;
    }
</style>
</head>
<body>

<h2>Location Verification</h2>

<div id="circle">0m</div>
<p id="message">Checking your location…</p>
<p id="distance"></p>
<p id="accuracy"></p>

<button id="retryBtn">Retry GPS</button>
<button id="openManually">Open Form Manually</button>
<button id="openMap">Open Target Location on Map</button>

<div id="formContainer" style="display:none;">
    <iframe id="formFrame"
        src="https://docs.google.com/forms/d/e/1FAIpQLSeLi6rBSMcIp0b08-YIJM3RdP7TPjgnjR15RLnzTji1Vg9a_A/viewform?usp=header">
    </iframe>
</div>

<script>
/* ==========================
      CONFIG
========================== */
const TARGET_LAT = 25.144911;
const TARGET_LNG = 75.862353;
const ALLOWED_RADIUS = 100; // meters

/* ==========================
      ELEMENTS
========================== */
const msg = document.getElementById("message");
const distEl = document.getElementById("distance");
const accEl = document.getElementById("accuracy");
const circle = document.getElementById("circle");
const retryBtn = document.getElementById("retryBtn");
const manualBtn = document.getElementById("openManually");
const mapBtn = document.getElementById("openMap");
const formContainer = document.getElementById("formContainer");
const formFrame = document.getElementById("formFrame");

/* ==========================
      SOUND (User Tap Safe)
========================== */
let siren = new Audio("https://www.soundjay.com/misc/sounds/siren-whistle-01.mp3");
siren.volume = 1.0;
document.body.addEventListener("click", () => {
    siren.play().catch(()=>{});
}, { once: true });

/* ==========================
      DISTANCE FUNCTION
========================== */
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI/180;
    const dLon = (lon2 - lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
              Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ==========================
      IFRAME FAIL DETECT
========================== */
let iframeLoaded = false;
formFrame.onload = () => {
    iframeLoaded = true;
};
setTimeout(() => {
    if (!iframeLoaded) {
        formContainer.style.display = "none";
        manualBtn.style.display = "inline-block";
    }
}, 5000);

/* ==========================
      GPS UPDATE HANDLER
========================== */
function updatePosition(pos) {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy || 0;

    accEl.textContent = `GPS Accuracy: ${Math.round(acc)}m`;

    const d = Math.round(distance(lat, lng, TARGET_LAT, TARGET_LNG));
    distEl.textContent = `Distance from target: ${d} meters`;
    circle.textContent = d + "m";

    if (d <= ALLOWED_RADIUS && acc < 75) {
        msg.textContent = "You are inside the allowed area ✔";
        circle.style.borderColor = "lime";
        circle.style.color = "lime";
        formContainer.style.display = "block";
        manualBtn.style.display = "none";
    } else {
        msg.textContent = "You are OUTSIDE the allowed area ❌";
        circle.style.borderColor = "red";
        circle.style.color = "red";
        formContainer.style.display = "none";
        manualBtn.style.display = "inline-block";
    }
}

/* ==========================
      GPS ERROR HANDLER
========================== */
function gpsError() {
    msg.textContent = "Unable to get location. Enable GPS!";
    retryBtn.style.display = "inline-block";
    manualBtn.style.display = "inline-block";
}

/* ==========================
      GPS START
========================== */
function startGPS() {
    msg.textContent = "Locating…";
    retryBtn.style.display = "none";

    if (!navigator.geolocation) {
        gpsError();
        return;
    }

    navigator.geolocation.watchPosition(updatePosition, gpsError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
    });
}

retryBtn.onclick = startGPS;
manualBtn.onclick = () => window.open(formFrame.src, "_blank");
mapBtn.onclick = () =>
    window.open(`https://www.google.com/maps?q=${TARGET_LAT},${TARGET_LNG}`, "_blank");

startGPS();
</script>

</body>
</html>
